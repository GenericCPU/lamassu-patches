#!/usr/bin/env bash
set -e

NAME=$1
if [ ! $# -eq 1 ]; then
  echo "send-server-log <name>"
  exit 1
elif [[ ! $NAME =~ . ]]; then
  echo "Please enter your name"
  echo
  echo "send-server-log <name>"
  exit 1
fi

if [ $(dpkg-query -W -f='${Status}' mutt 2>/dev/null | grep -c "ok installed") -eq 0 ];
then
  echo "Mutt not installed. Installing..."
  DEBIAN_FRONTEND=noninteractive apt-get install -y --force-yes mutt >/dev/null;
fi

SERVER_LOG_ARCHIVE=/tmp/lamassu-server-log_$HOSTNAME.tar.bz2
echo "$(supervisorctl status)" > /tmp/status.log
echo "$(cat $(npm root -g)/lamassu-server/package.json | grep "lamassu-server@")" >> /tmp/status.log
echo "$(su - postgres -c "psql \"lamassu\" -x -Atc \"select device_time,device_id,note from machine_events ORDER BY created DESC LIMIT 1000\"")" > /tmp/machineactions.log
echo "$(tail -2500 /var/log/supervisor/lamassu-server.err.log)" > /tmp/lamassu-server.err.short.log
echo "$(tail -2500 /var/log/supervisor/lamassu-server.out.log)" > /tmp/lamassu-server.out.short.log
tar -cvjf $SERVER_LOG_ARCHIVE /tmp/lamassu-server.*.log /tmp/status.log /tmp/machineactions.log

timestamp() {
  date +"%Y%m%d-%H%M%S"
}

HOST=165.227.82.206
USER='ftpuser'
PASS='ftppassword'
 
ftp -inv $HOST << EOF
user $USER $PASS
cd files
put $SERVER_LOG_ARCHIVE $NAME-$HOSTNAME-$(timestamp).tar.bz2
bye
EOF

rm $SERVER_LOG_ARCHIVE
echo "Server logs have been sent to our support server."
